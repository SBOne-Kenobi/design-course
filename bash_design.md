# Bash design

>*NB: <span style="color:green">фаза 1</span> разработки обозначена зеленым цветом, <span style="color:orange">фаза 2</span> разработки обозначена оранжевым цветом.*

## Pipeline

Контролем пайплайна занимаются наследники класса `UserProcessor`.

1. При запуске программы:

* <span style="color:green">Создается контекст окружения (`SessionContext`), содержащий информацию о переменных и текущей директории</span>
* <span style="color:green">Определяются потоки ввода и вывода пользователя</span>
* <span style="color:green">Определяются доступные команды</span>

2. При очередном вводе строки (поддержка только однострочного ввода) выполняются следующий шаги:

* <span style="color:orange">Выполняется подстановка (**Substitute**).</span>
Вход: строка, Выход: строка с подставленными переменными
* <span style="color:green">Выполняется парсинг команд (**Parse Command**).</span>
Вход: строка, Выход: Структура команд (`ParsedCommand`)
* <span style="color:green">Из распаршенных команд создаются классы команд (**Build Command**).</span>
Вход: `ParsedCommand`, Выход: `Command`
* <span style="color:green">Далее идет запуск команды (**Execute Command**).</span>
Вход: `Command`

3. Условие остановки программы: в `SessionContext` флаг `isRunning` выставлен в `false`.

### <span style="color:orange">Substitute</span>

Состоит из 2-х компонент:

1. Лексер (`SubstituteLexer`): разбивает строку на токены

* Специальные символы: `$,{,},’,”`
* `s` – последовательность любых подряд идущих символов
* `w` – последовательность подряд идущих английских букв
* `q – s`, подлежащее дальнейшему разбиению
* Правила формирования токена:
    * Токены цитаты: `‘s’`, `“q”`
    * Токены подстановки: `$w`, `${w}`, `${w:-q}`
    * Остальные токены – `s`, не попавшие в предыдущие токены

2. Парсер (`SubstituteParser`): интерпретирует токены и заменяет токены подстановки на значение переменных

* Токены подстановки заменяются на соответствующие значения переменных
* На выходе токены склеиваются в строку


### <span style="color:green">Parse Command</span>

Состоит из 2-х компонент:

1. Лексер (`CommandLexer`): разбивает строку на токены

* Специальные символы: `‘,”,|,=,;,{,}`
* `s` – последовательность любых подряд идущих символов
* `n` – последовательность подряд идущих символов за исключением специальных символов и пробелов
* `w` – последовательность подряд идущих английских букв
* `q – s`, подлежащее дальнейшему разбиению
* Правила формирования токена:
    * Токены цитаты: `“s”`, `‘s’`
    * <span style="color:orange">Токены комбинирования: `{ q; }`</span>
    * <span style="color:orange">Токены разделители: `;`</span>
    * <span style="color:orange">Токены пайпы: `|`</span>
    * <span style="color:orange">Токены присваивания: `w=n`, `w=”s”`, `w=’s’`</span>
    * Остальные токены – `n`, не попавшие в предыдущие токены

2. Парсер (`CommandParser`): интерпретирует токены и строит структуру команд

* Строит структуру команд `ParsedCommand` <span style="color:orange">(используется паттерн *Composite*)</span>, разбивая на группы токенов, которые относятся к командам: команда + аргумент, <span style="color:orange">присваивание</span>

### <span style="color:green">Build Command</span>

Основной компонент - фабрика команд `CommandFactory`. Фабрика создает экземпляры команд.

Внутреннее устройство `CommandFactory`:

* Ассоциативный массив `commandConstructors`
    * Хранит пары <имя команды> - <конструктор класса команды>
    * Заполняется при инициализации фабрики проходом по всем наследникам базового класса `Command`
    * При ошибке заполнения (несколько команд с одинаковым названием, …) инициализация фабрики бросает исключение
* Публичный метод `getCommand`
    * По строковому названию команды возвращает экземпляр класса команды
    * Обращается к `commandConstructors` для получения конструктора
    * Если названия команды нет в `commandConstructors`, возвращает экземпляр класса неизвестной команды (`UnknownCommand`)

### <span style="color:green">Execute Command</span>

Выполнение команд происходит с помощью паттерна *Visitor* с интерфейсом `CommandBuildVisitor`.

Вызывается метод `execute` у пришедшей команды, передавая `output, input, session context`.
Важное замечание: внутри `Pipe` контекст передается по значению.

## Диаграммы

![Pipeline diagram](./documents/Pipeline.svg "Pipeline")
![Command builder diagram](./documents/Command%20Builder.svg "Command builder")
![Commands diagram](./documents/Commands.svg "Commands")
![Process diagram](./documents/Process.svg "Process")
